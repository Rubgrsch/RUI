local _, rui = ...
local B, L, C = unpack(rui)
local MP = B.MP
local TT = B.TT

-- SL, converted from MDT
local progressList = {
	[164501] = 0,
	[165872] = 4,
	[173044] = 4,
	[173714] = 16,
	[167116] = 4,
	[172312] = 4,
	[167117] = 1,
	[168934] = 8,
	[164185] = 0,
	[167532] = 20,
	[168361] = 8,
	[166608] = 0,
	[167533] = 20,
	[170147] = 0,
	[169159] = 0,
	[165111] = 2,
	[168968] = 0,
	[164920] = 4,
	[167534] = 20,
	[169861] = 25,
	[169893] = 6,
	[170690] = 4,
	[164857] = 2,
	[168969] = 1,
	[164921] = 4,
	[170850] = 7,
	[170882] = 4,
	[168396] = 12,
	[168747] = 0,
	[162691] = 0,
	[168843] = 12,
	[168365] = 0,
	[169927] = 5,
	[162309] = 0,
	[165911] = 4,
	[163457] = 4,
	[168844] = 12,
	[168717] = 4,
	[162693] = 0,
	[164255] = 0,
	[164861] = 2,
	[163618] = 8,
	[162102] = 0,
	[166264] = 0,
	[168591] = 4,
	[168878] = 8,
	[160495] = 4,
	[168942] = 6,
	[163619] = 4,
	[165946] = 0,
	[171333] = 2,
	[172265] = 4,
	[171376] = 10,
	[163524] = 5,
	[162047] = 7,
	[162058] = 0,
	[163620] = 6,
	[167955] = 1,
	[167962] = 8,
	[162099] = 0,
	[171455] = 1,
	[162057] = 7,
	[167892] = 0,
	[162059] = 0,
	[163621] = 6,
	[162038] = 7,
	[164705] = 6,
	[164737] = 12,
	[162729] = 4,
	[166396] = 4,
	[164578] = 0,
	[162060] = 0,
	[163622] = 0,
	[164929] = 7,
	[164451] = 0,
	[163501] = 4,
	[167956] = 1,
	[168627] = 8,
	[162051] = 2,
	[162061] = 0,
	[163623] = 0,
	[162049] = 4,
	[164707] = 6,
	[162056] = 1,
	[166301] = 4,
	[162763] = 8,
	[171448] = 4,
	[162317] = 0,
	[165919] = 6,
	[167610] = 1,
	[162039] = 4,
	[174175] = 4,
	[164517] = 0,
	[164804] = 0,
	[171799] = 7,
	[169875] = 2,
	[165410] = 0,
	[162100] = 0,
	[165076] = 4,
	[162046] = 1,
	[170480] = 5,
	[169905] = 6,
	[165529] = 4,
	[168949] = 4,
	[167607] = 7,
	[167611] = 4,
	[165415] = 2,
	[164563] = 4,
	[166304] = 4,
	[168886] = 25,
	[168153] = 12,
	[171500] = 1,
	[163882] = 14,
	[167994] = 4,
	[171341] = 1,
	[168058] = 1,
	[174210] = 4,
	[167612] = 6,
	[164218] = 0,
	[163086] = 8,
	[167963] = 5,
	[163915] = 10,
	[165222] = 4,
	[165408] = 0,
	[164266] = 0,
	[167876] = 20,
	[168155] = 0,
	[168022] = 10,
	[167964] = 8,
	[165414] = 4,
	[171343] = 5,
	[166275] = 4,
	[164267] = 0,
	[171184] = 12,
	[164967] = 0,
	[164873] = 4,
	[167965] = 5,
	[171342] = 2,
	[168681] = 6,
	[166276] = 4,
	[163503] = 2,
	[164555] = 0,
	[166299] = 4,
	[163089] = 1,
	[163121] = 5,
	[167998] = 8,
	[163077] = 0,
	[168572] = 8,
	[168845] = 12,
	[164556] = 0,
	[163058] = 4,
	[164450] = 0,
	[163122] = 0,
	[163520] = 6,
	[164461] = 0,
	[168318] = 8,
	[166302] = 4,
	[164557] = 10,
	[171474] = 0,
	[168718] = 4,
	[162103] = 0,
	[163458] = 4,
	[163459] = 4,
	[168574] = 8,
	[163506] = 4,
	[164558] = 0,
	[162040] = 7,
	[163857] = 4,
	[171181] = 4,
	[167967] = 6,
	[164463] = 0,
	[165515] = 4,
	[170572] = 6,
	[164862] = 3,
	[162041] = 2,
	[164567] = 0,
	[167536] = 20,
	[165197] = 12,
	[164464] = 0,
	[172981] = 5,
	[170838] = 4,
	[163891] = 6,
	[168986] = 3,
	[162329] = 0,
	[163126] = 0,
	[167493] = 8,
	[162689] = 0,
	[173720] = 16,
	[162744] = 20,
	[167111] = 5,
	[168418] = 4,
	[170490] = 5,
	[168992] = 4,
	[167538] = 20,
	[164506] = 5,
	[168578] = 8,
	[165824] = 15,
	[164562] = 4,
	[166079] = 0,
	[166411] = 1,
	[163128] = 4,
	[167731] = 4,
	[163892] = 6,
	[171384] = 4,
	[164510] = 4,
	[167113] = 4,
	[168420] = 4,
	[165137] = 6,
	[163894] = 12,
	[163862] = 8,
	[173655] = 16,
	[168580] = 8,
	[174197] = 4,
	[164926] = 6,
	[169696] = 8,
	[165138] = 1,
	[163157] = 0,
	[173016] = 4,
}

local function GetNPCID(guid)
	local unitType, _, _, _, _, id = strsplit("-", guid)
	if unitType == "Creature" and id then
		return tonumber(id)
	end
end

local function OnTooltipSetUnit(tooltip)
	if not MP.currentRun.MPing then return end
	local _, unit = tooltip:GetUnit()
	if not unit then return end
	if not UnitCanAttack("player", unit) or UnitIsDead(unit) then return end

	local id = GetNPCID(UnitGUID(unit))
	if not id then return end
	local value = progressList[id]
	if not value then return end

	local _, _, steps = C_Scenario.GetStepInfo()
	local name, _, _, _, totalQuantity = C_Scenario.GetCriteriaInfo(steps)
	if totalQuantity then -- in rare condition it can be nil even MPing is true
		local percent = value / totalQuantity * 100
		percent = math.floor(percent * 100 + 0.5) / 100

		tooltip:AddDoubleLine(name, "+" .. percent .. "% (+" .. value .. ")")
		tooltip:Show()
	end
end

B:AddInitScript(function()
	if MP.currentRun.MPing or C.db.instance.mythicPlus.progress then
		TT:HookScript("OnTooltipSetUnit", OnTooltipSetUnit)
	end
--[[
	local t = {}
	ruiDB.MDTProgress = t
	for dungeonIndex,v in pairs(MDT.dungeonEnemies) do
		for kk, vv in pairs(v) do
			t[vv.id] = vv.count
		end
	end]]
end)

local _, rui = ...
local B, L, C = unpack(rui)
local MP = B.MP
local TT = B.TT

-- SL, converted from MDT
local progressList = {
	[134139] = 10,
	[151658] = 4,
	[96609] = 0,
	[134012] = 6,
	[136186] = 9,
	[129601] = 4,
	[168155] = 0,
	[97185] = 10,
	[120778] = 0,
	[99359] = 3,
	[138489] = 8,
	[173655] = 16,
	[150254] = 4,
	[144244] = 0,
	[95779] = 10,
	[129602] = 6,
	[161124] = 4,
	[131585] = 4,
	[120779] = 0,
	[99360] = 9,
	[131586] = 4,
	[96611] = 2,
	[164578] = 0,
	[144246] = 0,
	[134144] = 18,
	[131587] = 5,
	[164451] = 0,
	[126918] = 4,
	[111637] = 4,
	[130435] = 5,
	[144248] = 0,
	[133379] = 0,
	[122571] = 8,
	[169696] = 8,
	[98275] = 4,
	[126983] = 0,
	[127111] = 6,
	[168418] = 4,
	[130436] = 1,
	[141565] = 1,
	[165222] = 4,
	[127879] = 4,
	[138369] = 0,
	[137474] = 6,
	[124171] = 4,
	[130437] = 2,
	[128455] = 6,
	[134150] = 36,
	[174175] = 4,
	[96934] = 2,
	[131849] = 4,
	[128967] = 4,
	[119952] = 4,
	[98533] = 10,
	[131850] = 4,
	[134024] = 1,
	[127497] = 9,
	[137989] = 1,
	[135048] = 4,
	[99365] = 4,
	[98406] = 4,
	[137478] = 6,
	[135049] = 2,
	[139269] = 4,
	[128649] = 0,
	[164461] = 0,
	[129928] = 0,
	[128969] = 8,
	[138247] = 1,
	[135562] = 2,
	[140038] = 2,
	[105952] = 6,
	[98919] = 4,
	[133389] = 0,
	[121553] = 4,
	[164463] = 0,
	[114584] = 1,
	[98280] = 4,
	[114712] = 0,
	[150142] = 4,
	[98728] = 7,
	[136076] = 6,
	[134158] = 6,
	[128651] = 0,
	[129802] = 0,
	[150143] = 4,
	[101414] = 2,
	[133392] = 0,
	[129227] = 0,
	[131858] = 4,
	[122322] = 4,
	[129547] = 4,
	[137485] = 4,
	[115417] = 8,
	[127757] = 4,
	[167536] = 20,
	[114714] = 4,
	[102566] = 12,
	[105699] = 3,
	[150146] = 4,
	[129548] = 4,
	[101991] = 4,
	[137487] = 4,
	[115418] = 8,
	[97068] = 5,
	[129547000] = 0,
	[102375] = 3,
	[114715] = 4,
	[122963] = 0,
	[105636] = 4,
	[106787] = 1,
	[150276] = 5,
	[127503] = 0,
	[162041] = 2,
	[115419] = 8,
	[135699] = 7,
	[97197] = 2,
	[99307] = 12,
	[114716] = 1,
	[165111] = 2,
	[98732] = 1,
	[129550] = 4,
	[115484] = 4,
	[104295] = 1,
	[124947] = 1,
	[122965] = 0,
	[134423] = 1,
	[129231] = 0,
	[98733] = 4,
	[136214] = 36,
	[136470] = 4,
	[90997] = 4,
	[134041] = 4,
	[135192] = 4,
	[162046] = 1,
	[105703] = 1,
	[150154] = 4,
	[129552] = 6,
	[98926] = 4,
	[162047] = 7,
	[115486] = 8,
	[90998] = 4,
	[97200] = 4,
	[164861] = 2,
	[122967] = 0,
	[105704] = 4,
	[99630] = 1,
	[127315] = 0,
	[132126] = 4,
	[174197] = 4,
	[162049] = 4,
	[171384] = 4,
	[139799] = 9,
	[162689] = 0,
	[134173] = 1,
	[122968] = 0,
	[101549] = 1,
	[105705] = 4,
	[139800] = 9,
	[168572] = 8,
	[134174] = 5,
	[162051] = 2,
	[134686] = 4,
	[102253] = 4,
	[97202] = 0,
	[164737] = 12,
	[122969] = 4,
	[100527] = 3,
	[105706] = 10,
	[150160] = 5,
	[127381] = 3,
	[114338] = 10,
	[162309] = 0,
	[104300] = 4,
	[162693] = 0,
	[113699] = 8,
	[122970] = 4,
	[163077] = 0,
	[131492] = 4,
	[101679] = 4,
	[95861] = 4,
	[166275] = 4,
	[150547] = 1,
	[139422] = 6,
	[100529] = 1,
	[166276] = 4,
	[134691] = 4,
	[168578] = 8,
	[150292] = 5,
	[162057] = 7,
	[150165] = 5,
	[150293] = 4,
	[135204] = 4,
	[122972] = 4,
	[162058] = 0,
	[129366] = 4,
	[170882] = 4,
	[139425] = 4,
	[162059] = 0,
	[99188] = 4,
	[138019] = 4,
	[96247] = 1,
	[164873] = 4,
	[122973] = 4,
	[100531] = 8,
	[98677] = 1,
	[134056] = 0,
	[122398] = 4,
	[99956] = 4,
	[162061] = 0,
	[162317] = 0,
	[129879] = 0,
	[135975] = 0,
	[174210] = 4,
	[68819] = 12,
	[165515] = 4,
	[134058] = 0,
	[168968] = 0,
	[137511] = 4,
	[166411] = 1,
	[91006] = 4,
	[168969] = 1,
	[129369] = 8,
	[95674] = 0,
	[134060] = 0,
	[121569] = 4,
	[97081] = 5,
	[168843] = 12,
	[138281] = 6,
	[114792] = 4,
	[163089] = 1,
	[129370] = 4,
	[151325] = 0,
	[130521] = 1,
	[122401] = 8,
	[153755] = 0,
	[91008] = 4,
	[133935] = 8,
	[134063] = 0,
	[98425] = 4,
	[135470] = 0,
	[98681] = 6,
	[168718] = 4,
	[130522] = 2,
	[169875] = 2,
	[162744] = 20,
	[137517] = 4,
	[132530] = 0,
	[97083] = 5,
	[100216] = 4,
	[135472] = 0,
	[130011] = 4,
	[98362] = 0,
	[114794] = 4,
	[105651] = 10,
	[105715] = 4,
	[162329] = 0,
	[129372] = 4,
	[164464] = 0,
	[98810] = 6,
	[122403] = 4,
	[163086] = 8,
	[167533] = 20,
	[132532] = 0,
	[97084] = 5,
	[139949] = 4,
	[169927] = 5,
	[130012] = 4,
	[163862] = 8,
	[162763] = 8,
	[102583] = 4,
	[130909] = 4,
	[164506] = 5,
	[129373] = 4,
	[115115] = 4,
	[144298] = 6,
	[122404] = 4,
	[170850] = 7,
	[137521] = 4,
	[120550] = 4,
	[133685] = 4,
	[167532] = 20,
	[125857] = 0,
	[134069] = 0,
	[167956] = 1,
	[114796] = 4,
	[133430] = 8,
	[163459] = 4,
	[96574] = 5,
	[129374] = 4,
	[92610] = 4,
	[144300] = 0,
	[126497] = 0,
	[130653] = 4,
	[167538] = 20,
	[167534] = 20,
	[104247] = 4,
	[114541] = 1,
	[133943] = 0,
	[144301] = 1,
	[160495] = 4,
	[167994] = 4,
	[91332] = 4,
	[167998] = 8,
	[164510] = 4,
	[165529] = 4,
	[133944] = 0,
	[98813] = 4,
	[129367] = 4,
	[131847] = 4,
	[163620] = 6,
	[165911] = 4,
	[97087] = 2,
	[114542] = 4,
	[141495] = 1,
	[144303] = 4,
	[115757] = 8,
	[162691] = 0,
	[119977] = 4,
	[163622] = 0,
	[163621] = 6,
	[96640] = 2,
	[165919] = 6,
	[173044] = 4,
	[122407] = 4,
	[163157] = 0,
	[167731] = 4,
	[166299] = 4,
	[163122] = 0,
	[165872] = 4,
	[125860] = 8,
	[171500] = 1,
	[136249] = 36,
	[134331] = 6,
	[119978] = 1,
	[166264] = 0,
	[163126] = 0,
	[130400] = 6,
	[171799] = 7,
	[150297] = 4,
	[122408] = 4,
	[91782] = 10,
	[173016] = 4,
	[166301] = 4,
	[163618] = 8,
	[114544] = 4,
	[118700] = 2,
	[165137] = 6,
	[101437] = 0,
	[122984] = 6,
	[172312] = 4,
	[166302] = 4,
	[171376] = 10,
	[150190] = 0,
	[155433] = 4,
	[131812] = 6,
	[167965] = 5,
	[91783] = 4,
	[95939] = 10,
	[100539] = 4,
	[104251] = 4,
	[98177] = 12,
	[155434] = 4,
	[163128] = 4,
	[101438] = 4,
	[114801] = 4,
	[173714] = 16,
	[166304] = 4,
	[165138] = 1,
	[162729] = 4,
	[163619] = 4,
	[172265] = 4,
	[135231] = 8,
	[137405] = 0,
	[129699] = 4,
	[133990] = 1,
	[165410] = 0,
	[168591] = 4,
	[97219] = 0,
	[167955] = 1,
	[98370] = 4,
	[114802] = 4,
	[162040] = 7,
	[162099] = 0,
	[99649] = 12,
	[127480] = 1,
	[105915] = 4,
	[162038] = 7,
	[168992] = 4,
	[134338] = 9,
	[166396] = 4,
	[167612] = 6,
	[162056] = 1,
	[150195] = 4,
	[118703] = 4,
	[150253] = 6,
	[135234] = 3,
	[114803] = 4,
	[168058] = 1,
	[162039] = 4,
	[164517] = 0,
	[130404] = 4,
	[163623] = 0,
	[168681] = 6,
	[122412] = 0,
	[91786] = 4,
	[162060] = 0,
	[131527] = 0,
	[165414] = 4,
	[163503] = 2,
	[118704] = 10,
	[151476] = 8,
	[163524] = 5,
	[114804] = 4,
	[168318] = 8,
	[136643] = 12,
	[165415] = 2,
	[168845] = 12,
	[98756] = 4,
	[164567] = 0,
	[128551] = 4,
	[130661] = 4,
	[168844] = 12,
	[163520] = 6,
	[168420] = 4,
	[168717] = 4,
	[118705] = 10,
	[105682] = 8,
	[163882] = 14,
	[135366] = 6,
	[131402] = 1,
	[134599] = 4,
	[163458] = 4,
	[163457] = 4,
	[136006] = 0,
	[169893] = 6,
	[135239] = 4,
	[122478] = 2,
	[133007] = 0,
	[134600] = 4,
	[91787] = 1,
	[164267] = 0,
	[118706] = 2,
	[168580] = 8,
	[115765] = 16,
	[170147] = 0,
	[164705] = 6,
	[114783] = 4,
	[96584] = 4,
	[163501] = 4,
	[168574] = 8,
	[168361] = 8,
	[135241] = 4,
	[129640] = 4,
	[169861] = 25,
	[134602] = 4,
	[91785] = 2,
	[133835] = 4,
	[133963] = 1,
	[130024] = 1,
	[129553] = 10,
	[168627] = 8,
	[169159] = 0,
	[163857] = 4,
	[164266] = 0,
	[133836] = 4,
	[98759] = 4,
	[164707] = 6,
	[144286] = 0,
	[91790] = 4,
	[164255] = 0,
	[171474] = 0,
	[97097] = 4,
	[163915] = 10,
	[168747] = 0,
	[102404] = 4,
	[136353] = 10,
	[115831] = 4,
	[163121] = 5,
	[101637] = 0,
	[164967] = 0,
	[102788] = 4,
	[105921] = 4,
	[164501] = 0,
	[135245] = 8,
	[167117] = 1,
	[95947] = 4,
	[168365] = 0,
	[164804] = 0,
	[163506] = 4,
	[134990] = 4,
	[138187] = 4,
	[164920] = 4,
	[173720] = 16,
	[162100] = 0,
	[133482] = 1,
	[96587] = 4,
	[150712] = 0,
	[134991] = 6,
	[168878] = 8,
	[163891] = 6,
	[91792] = 10,
	[163058] = 4,
	[164921] = 4,
	[131667] = 0,
	[144071] = 4,
	[138061] = 0,
	[130027] = 7,
	[163892] = 6,
	[171181] = 4,
	[162102] = 0,
	[101639] = 0,
	[167607] = 7,
	[167611] = 4,
	[134993] = 0,
	[164563] = 4,
	[144294] = 4,
	[98954] = 4,
	[162103] = 0,
	[164218] = 0,
	[131669] = 1,
	[165408] = 0,
	[134994] = 1,
	[130028] = 7,
	[163894] = 12,
	[97163] = 0,
	[164557] = 10,
	[164562] = 4,
	[134739] = 10,
	[134157] = 4,
	[138064] = 0,
	[169905] = 6,
	[164450] = 0,
	[91794] = 1,
	[114364] = 1,
	[171184] = 12,
	[164555] = 0,
	[126832] = 0,
	[118712] = 0,
	[167962] = 8,
	[141285] = 4,
	[164556] = 0,
	[111563] = 4,
	[116549] = 4,
	[167967] = 6,
	[97677] = 1,
	[168934] = 8,
	[171342] = 2,
	[122421] = 8,
	[164857] = 2,
	[133463] = 12,
	[131545] = 0,
	[127119] = 0,
	[164862] = 3,
	[118713] = 4,
	[167964] = 8,
	[135254] = 4,
	[168942] = 6,
	[170480] = 5,
	[167963] = 5,
	[171333] = 2,
	[137940] = 4,
	[170490] = 5,
	[168886] = 25,
	[134232] = 4,
	[91796] = 10,
	[168986] = 3,
	[134616] = 2,
	[168949] = 4,
	[145185] = 0,
	[151657] = 4,
	[100364] = 4,
	[165946] = 0,
	[150396] = 0,
	[135235] = 4,
	[134617] = 1,
	[144296] = 5,
	[151659] = 4,
	[144295] = 4,
	[144249] = 0,
	[122423] = 8,
	[144299] = 4,
	[144293] = 6,
	[152009] = 5,
	[131677] = 6,
	[167610] = 1,
	[150168] = 6,
	[172981] = 5,
	[135258] = 1,
	[119930] = 4,
	[120366] = 4,
	[136665] = 7,
	[138255] = 4,
	[96657] = 12,
	[128434] = 4,
	[98770] = 4,
	[164926] = 6,
	[134364] = 4,
	[126919] = 4,
	[171448] = 4,
	[122971] = 4,
	[113537] = 10,
	[114624] = 8,
	[150169] = 4,
	[135240] = 2,
	[150159] = 0,
	[150295] = 0,
	[115388] = 12,
	[131825] = 0,
	[150222] = 0,
	[128435] = 1,
	[135365] = 16,
	[131864] = 0,
	[166079] = 0,
	[133593] = 5,
	[135474] = 4,
	[131863] = 0,
	[97170] = 4,
	[114625] = 1,
	[165824] = 15,
	[164929] = 7,
	[135329] = 10,
	[131824] = 0,
	[131819] = 4,
	[131670] = 6,
	[135052] = 1,
	[127485] = 3,
	[127477] = 6,
	[133852] = 4,
	[133345] = 5,
	[102094] = 4,
	[97043] = 4,
	[131666] = 4,
	[97171] = 10,
	[114626] = 4,
	[114632] = 4,
	[131445] = 9,
	[135706] = 3,
	[130026] = 6,
	[130025] = 7,
	[127482] = 4,
	[98706] = 6,
	[101839] = 4,
	[136160] = 0,
	[106059] = 4,
	[131112] = 6,
	[102095] = 4,
	[116550] = 4,
	[131685] = 4,
	[97172] = 1,
	[102351] = 1,
	[127479] = 0,
	[127484] = 0,
	[130582] = 0,
	[139110] = 11,
	[171455] = 1,
	[137484] = 6,
	[141283] = 4,
	[134418] = 9,
	[95766] = 4,
	[91001] = 4,
	[98963] = 1,
	[133912] = 6,
	[131383] = 0,
	[104270] = 8,
	[97173] = 4,
	[114628] = 4,
	[167876] = 20,
	[97365] = 4,
	[138465] = 4,
	[122413] = 4,
	[134629] = 6,
	[167493] = 8,
	[170690] = 4,
	[130485] = 12,
	[129526] = 4,
	[98900] = 4,
	[108151] = 0,
	[134284] = 4,
	[155090] = 4,
	[100249] = 4,
	[131817] = 0,
	[114629] = 4,
	[126969] = 0,
	[135322] = 0,
	[167111] = 5,
	[95842] = 2,
	[119923] = 4,
	[114334] = 4,
	[131818] = 4,
	[139626] = 1,
	[129527] = 4,
	[95832] = 2,
	[114526] = 1,
	[100250] = 4,
	[135475] = 0,
	[98366] = 4,
	[136934] = 4,
	[95843] = 5,
	[141282] = 1,
	[136295] = 13,
	[167113] = 4,
	[129208] = 0,
	[136297] = 9,
	[137830] = 4,
	[96664] = 2,
	[133663] = 4,
	[95769] = 4,
	[135167] = 4,
	[131436] = 6,
	[134417] = 12,
	[155094] = 4,
	[104273] = 0,
	[131821] = 0,
	[118723] = 10,
	[141284] = 4,
	[134251] = 4,
	[134005] = 1,
	[165197] = 12,
	[129559] = 4,
	[130635] = 4,
	[164558] = 0,
	[130488] = 4,
	[129529] = 4,
	[95834] = 2,
	[167116] = 4,
	[122560] = 0,
	[105629] = 1,
	[104274] = 0,
	[131823] = 0,
	[118724] = 4,
	[99358] = 4,
	[98368] = 4,
	[105617] = 4,
	[102584] = 4,
	[168396] = 12,
	[128652] = 0,
	[133870] = 4,
	[102430] = 1,
	[95771] = 4,
	[122405] = 4,
	[151773] = 4,
	[115488] = 4,
	[104278] = 10,
	[104275] = 0,
	[126845] = 0,
	[114633] = 4,
	[96677] = 2,
	[133436] = 5,
	[137029] = 5,
	[98521] = 10,
	[138002] = 1,
	[170572] = 6,
	[166608] = 0,
	[98243] = 4,
	[95772] = 4,
	[114627] = 4,
	[137969] = 6,
	[99033] = 4,
	[98691] = 4,
	[141566] = 1,
	[100248] = 4,
	[114634] = 4,
	[133432] = 5,
	[91793] = 1,
	[136250] = 4,
	[171341] = 1,
	[133384] = 0,
	[135846] = 2,
	[128650] = 0,
	[139946] = 6,
	[127486] = 7,
	[151649] = 4,
	[165076] = 4,
	[134514] = 9,
	[129788] = 4,
	[104277] = 4,
	[126847] = 0,
	[97678] = 8,
	[137473] = 4,
	[118719] = 4,
	[131318] = 0,
	[171343] = 5,
	[161241] = 4,
	[115019] = 8,
	[105876] = 1,
	[126928] = 4,
	[99366] = 4,
	[138254] = 1,
	[137614] = 0,
	[102104] = 4,
	[137713] = 1,
	[102232] = 4,
	[126848] = 0,
	[114636] = 4,
	[167892] = 0,
	[98792] = 4,
	[155432] = 0,
	[129214] = 0,
	[161243] = 4,
	[115020] = 8,
	[91000] = 8,
	[137516] = 4,
	[127488] = 7,
	[129598] = 0,
	[98538] = 10,
	[164185] = 0,
	[161244] = 4,
	[136139] = 12,
	[97182] = 6,
	[114637] = 4,
	[138464] = 4,
	[168022] = 10,
	[95920] = 2,
	[92387] = 0,
	[137716] = 0,
	[127124] = 0,
	[129232] = 0,
	[99804] = 2,
	[103459] = 0,
	[129599] = 3,
	[98973] = 1,
	[137486] = 4,
	[120770] = 0,
	[97119] = 1,
	[150249] = 4,
	[136347] = 1,
	[134137] = 9,
	[127799] = 4,
	[127106] = 6,
	[96480] = 1,
	[100526] = 4,
	[96608] = 2,
	[150250] = 4,
	[170838] = 4,
	[127490] = 0,
	[129600] = 3,
	[168153] = 12,
	[98173] = 4,
	[118717] = 4,
	[129371] = 4,
	[150251] = 4,
	[118716] = 4,
}

function MP:GetNPCID(guid)
	local unitType, _, _, _, _, id = strsplit("-", guid)
	if unitType == "Creature" and id then
		return tonumber(id)
	end
end

function MP:GetNPCProgress(npcid)
	if MP.currentRun.MPing then
		local v = progressList[npcid]
		if v then return v end
	end
end

local function OnTooltipSetUnit(tooltip)
	if not MP.currentRun.MPing then return end
	local _, unit = tooltip:GetUnit()
	if not unit then return end
	if not UnitCanAttack("player", unit) or UnitIsDead(unit) then return end

	local id = MP:GetNPCID(UnitGUID(unit))
	if not id then return end
	local value = progressList[id]
	if not value then return end

	local _, _, steps = C_Scenario.GetStepInfo()
	local name, _, _, _, totalQuantity = C_Scenario.GetCriteriaInfo(steps)
	if totalQuantity then -- in rare condition it can be nil even MPing is true
		local percent = value / totalQuantity * 100
		percent = math.floor(percent * 100 + 0.5) / 100

		tooltip:AddDoubleLine(name, "+" .. percent .. "% (+" .. value .. ")")
		tooltip:Show()
	end
end

B:AddInitScript(function()
	if MP.currentRun.MPing or C.db.instance.mythicPlus.progress then
		TT:HookScript("OnTooltipSetUnit", OnTooltipSetUnit)
	end
--[[
	local t = {}
	ruiDB.MDTProgress = t
	for dungeonIndex,v in pairs(MDT.dungeonEnemies) do
		for kk, vv in pairs(v) do
			t[vv.id] = vv.count
		end
	end--]]
end)
